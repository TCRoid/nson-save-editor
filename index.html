<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Naninovel Save Editor (.nson)</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #f0f2f5;
        }

        .navbar {
            background-color: #004d99 !important;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            padding: 16px 24px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #ffffff;
            font-weight: bold;
        }

        .github-icon {
            width: 24px;
            height: 24px;
            fill: #fff;
            transition: fill 0.2s ease-in-out;
        }

        .github-icon:hover {
            fill: #ccc;
        }

        #fileInput {
            display: none;
        }

        #jsoneditor {
            min-height: 0;
            height: 100%;
        }
    </style>
</head>

<body class="d-flex flex-column vh-100 overflow-hidden">

<!-- 标题栏 -->
<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
    <div class="container-fluid px-4">
        <a class="navbar-brand fw-bold" href="#">Naninovel Save Editor (.nson)</a>
        <a href="https://github.com/TCRoid/nson-save-editor" target="_blank" rel="noopener noreferrer"
           class="ms-auto me-2">
            <svg class="github-icon" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.01.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.11.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
        </a>
    </div>
</nav>

<!-- 警告 -->
<div class="container mt-4">
    <div class="mb-4 alert alert-danger alert-dismissible fade show" role="alert">
        为了避免存档损坏，请务必提前备份存档文件！
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
</div>

<!-- 主体内容 -->
<div class="container-fluid d-flex flex-column flex-grow-1 overflow-hidden">
    <div id="mainContent" class="card mx-lg-5 mb-4 shadow-sm h-100 d-flex flex-column flex-grow-1 overflow-hidden">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div id="fileName">请选择 *.nson 文件</div>
            <div>
                <input type="file" id="fileInput" accept=".nson">

                <button id="openButton" class="btn btn-primary btn-sm">打开文件</button>
                <button id="saveButton" class="btn btn-primary btn-sm">保存文件</button>
            </div>
        </div>

        <!-- JSON Editor -->
        <div class="card-body d-flex flex-column p-0 flex-grow-1 overflow-hidden">
            <div id="jsoneditor" class="flex-grow-1 "></div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fflate/umd/index.min.js"></script>

<script type="module">
    import {createJSONEditor} from 'https://cdn.jsdelivr.net/npm/vanilla-jsoneditor/standalone.js'

    let content = {
        text: undefined,
        json: {
            greeting: 'Hello World'
        }
    }

    let lastFileName = 'saved_data.nson';

    const JsonEditor = createJSONEditor({
        target: document.getElementById('jsoneditor'),
        props: {
            content,
            // content is an object { json: unknown } | { text: string }
            // console.log('onChange', {updatedContent, previousContent, contentErrors, patchResult})
            onChange: (updatedContent, previousContent, {contentErrors, patchResult}) => {
                content = updatedContent
            },

            onError: (err) => {
                console.error('onError', err)
            }
        }
    })

    const fileInput = document.getElementById('fileInput');
    const openButton = document.getElementById('openButton');
    const saveButton = document.getElementById('saveButton');

    // 设置压缩等级
    const deflateOptions = {level: 9}; // 最大压缩

    fileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;
        if (!file.name.endsWith('.nson')) {
            alert('请选择 .nson 文件');
            return;
        }

        // 文件名
        lastFileName = file.name;
        document.getElementById('fileName').textContent = file.name;

        const reader = new FileReader();
        reader.onload = function (evt) {
            const arrayBuffer = evt.target.result;
            try {
                // 解压
                const compressed = new Uint8Array(arrayBuffer);
                const decompressed = fflate.inflateSync(compressed, deflateOptions);
                // 解析为文本
                const text = new TextDecoder().decode(decompressed);
                JsonEditor.set({text: text});
            } catch (err) {
                alert('解析文件失败: ' + err);
            }
        };
        reader.readAsArrayBuffer(file);
    });

    openButton.addEventListener('click', function () {
        fileInput.click();
    });

    saveButton.addEventListener('click', function () {
        if (JsonEditor.validate()) {
            alert('JSON 内容格式错误，请修正后再保存');
            return;
        }

        try {
            const _content = JsonEditor.get();
            // 获取文本内容
            let textContent = _content.text;
            if (textContent === undefined && _content.json !== undefined) {
                textContent = JSON.stringify(_content.json, null, 2);
            }
            if (!textContent) {
                alert('编辑器内容为空，无法保存');
                return;
            }
            // 压缩
            const data = new TextEncoder().encode(textContent);
            const compressed = fflate.deflateSync(data, deflateOptions);

            // 创建 Blob 对象
            const blob = new Blob([compressed], {type: 'application/octet-stream'});

            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            // 默认文件名
            a.download = lastFileName;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(a.href);

        } catch (err) {
            alert('保存文件失败: ' + err);
        }
    });

    // 拖拽功能
    const mainContent = document.getElementById('mainContent');

    mainContent.addEventListener('dragover', function (e) {
        e.preventDefault();
        e.stopPropagation();
        mainContent.classList.add('border-primary');
    });

    mainContent.addEventListener('dragleave', function (e) {
        e.preventDefault();
        e.stopPropagation();
        mainContent.classList.remove('border-primary');
    });

    mainContent.addEventListener('drop', function (e) {
        e.preventDefault();
        e.stopPropagation();
        mainContent.classList.remove('border-primary');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            // 手动触发 change 事件
            fileInput.dispatchEvent(new Event('change'));
        }
    });
</script>

</body>
</html>